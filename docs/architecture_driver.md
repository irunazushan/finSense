# Architecture Drivers — FinSense

## 1. Problem Context

Современные банковские приложения предоставляют аналитику расходов и персонализированные советы, однако сталкиваются со следующими проблемами:

- Категоризация транзакций с использованием правил или простых моделей достигает точности около 85% и не учитывает поведенческий контекст. 
*(тут бы статейку, не факт откуда взялись 85%)*
- Использование LLM для всех транзакций экономически нецелесообразно и увеличивает задержку обработки.
- Отсутствует гибкая архитектура, позволяющая масштабировать AI-функциональность без существенной переработки системы.

Проект **FinSense** направлен на разработку гибридной архитектуры, сочетающей классическое машинное обучение (ML) и LLM-агентов в рамках событийно-ориентированной системы.

---

## 2. Business Goals

1. Достичь точности категоризации ≥ 95% при гибридной обработке (ML + LLM).
2. Снизить долю транзакций, требующих ручной проверки, до < 0.5%.
3. Предоставить персонализированные финансовые рекомендации на основе поведенческого анализа.
4. Обеспечить масштабируемость системы для обработки ≥ 1000 транзакций в секунду.
5. Создать архитектурную основу для добавления новых AI-функций без изменения ядра системы.

---

## 3. Quality Attributes

### 3.1 Производительность
- p95 времени категоризации < 2 секунд (с учётом LLM для сложных случаев).
- ML-классификация выполняется < 50 мс.

### 3.2 Пропускная способность
- Поддержка ≥ 1000 RPS при горизонтальном масштабировании consumer-узлов.

### 3.3 Надёжность
- Ни одна транзакция не должна быть потеряна.
- Используется модель доставки **at-least-once**.
- Компоненты обязаны быть идемпотентными при повторной обработке событий.
- При сбоях обработка должна возобновляться с места останова.

### 3.4 Масштабируемость
- Возможность масштабировать отдельно:
  - ML-классификатор
  - LLM-агенты
  - Kafka consumer-узлы

### 3.5 Стоимость
- LLM используется не более чем для ~10% транзакций.
- Общая стоимость обработки не должна превышать +15% по сравнению с ML-only режимом (расчёт на 1 млн транзакций).

### 3.6 Наблюдаемость
- Каждая транзакция имеет `transaction-id`
- Логи AI-агентов сохраняются для аудита в виде текстового файла.
- Метрики (latency, error rate, LLM usage) доступны для анализа.

### 3.7 Гибкость
- ML-модель и LLM-провайдер заменяемы через интерфейсы.
- Архитектура допускает добавление новых агентов без изменения доменной логики.

---

## 4. Constraints

- Один разработчик.
- Срок реализация As-is и To-be версий до 31 марта 2026
- Используются синтетические данные (генератор транзакций).
- Локальное развёртывание через Docker Compose; возможный деплой на VPS для демонстрации.
- Технологический стек фиксирован:
  - Kotlin/Java
  - Spring Boot
  - Apache Kafka
  - Postgres
  - Docker
  - Внешние LLM API или локальные модели

---

## 5. Architectural Principles

1. **Event-driven architecture** — все значимые изменения состояния публикуются как события.
2. **Hybrid Intelligence** — массовая обработка через ML, сложные случаи через LLM.
3. **Asynchronous Processing** — тяжёлые операции выполняются вне синхронного REST-пути.
4. **Loose Coupling** — взаимодействие сервисов осуществляется через события или чёткие API-контракты.
5. **Replaceability** — возможность замены ML или LLM без изменения доменной логики.
6. **Auditability** — решения AI сохраняются для последующего анализа и улучшения моделей.
7. **Инструментальность агентов** — Financial Coach Agent использует вызовы инструментов (функций) для получения точных данных, а не полагается на "знания" LLM.

---

## 6. Key Architectural Decisions

1. Apache Kafka используется как центральная шина событий.
2. Отдельный микросервис для ML-классификации (Classifier Service) с REST API для простоты и возможности замены на Python в будущем.
3. AI агенты реализованы как независимые компоненты.
4. Общая база данных Postgres для всех сервисов (упрощает разработку, но с разными схемами).
5. REST API используется только для чтения данных; тяжёлая обработка выполняется асинхронно.
6. Два AI-агента: Transaction Classifier (для сложной классификации) и Financial Coach (для рекомендаций)
7. Хранение ответов AI агентов в текстовом файле для аудита и анализа для улучшения качества ответов
