# FinSense AI Service Rules

<constraints>
- Реализация выполняется одним разработчиком.
- Срок реализации As-is и To-be версий: до 31 марта 2026 года.
- Для разработки и тестирования ДОЛЖНЫ использоваться синтетические данные (генератор транзакций).
- Локальное развёртывание ДОЛЖНО выполняться через Docker Compose.
- Допускается деплой на VPS только для демонстрации.
- Технологический стек фиксирован и НЕ ДОЛЖЕН изменяться: Kotlin/Java, Spring Boot, Apache Kafka, Postgres, Docker, внешние LLM API или локальные модели.
</constraints>

<architecture_rules>
- Архитектура ДОЛЖНА быть событийно-ориентированной: все значимые изменения состояния ДОЛЖНЫ публиковаться как события.
- Обработка ДОЛЖНА быть гибридной: массовые кейсы ДОЛЖНЫ обрабатываться ML, сложные кейсы ДОЛЖНЫ передаваться в LLM.
- Тяжёлые операции НЕ ДОЛЖНЫ выполняться в синхронном REST-пути и ДОЛЖНЫ выполняться асинхронно.
- Компоненты ДОЛЖНЫ быть слабо связаны: взаимодействие только через события или чёткие API-контракты.
- Замена ML-модели или LLM-провайдера НЕ ДОЛЖНА требовать изменений доменной логики.
- Решения AI ДОЛЖНЫ сохраняться для последующего анализа.
- Financial Coach Agent ДОЛЖЕН использовать вызовы инструментов (функций) для получения точных данных и НЕ ДОЛЖЕН полагаться на "знания" LLM.
</architecture_rules>

<implementation_rules>
- Apache Kafka ДОЛЖЕН использоваться как центральная шина событий.
- ML-классификация ДОЛЖНА быть вынесена в отдельный микросервис (Classifier Service).
- Classifier Service ДОЛЖЕН предоставлять REST API.
- AI-агенты ДОЛЖНЫ быть реализованы как независимые компоненты.
- Должны существовать два AI-агента: Transaction Classifier и Financial Coach.
- Postgres ДОЛЖЕН использоваться как общая БД для всех сервисов с разделением по схемам.
- REST API ДОЛЖЕН использоваться только для чтения данных.
- Тяжёлая обработка ДОЛЖНА выполняться асинхронно.
- Ответы AI-агентов ДОЛЖНЫ сохраняться в текстовом файле для аудита и анализа качества.
</implementation_rules>

<layer_rules>
- Слой API ДОЛЖЕН ограничиваться операциями чтения.
- Слой асинхронной обработки ДОЛЖЕН выполнять тяжёлые вычисления и AI-обработку.
- Слой событий ДОЛЖЕН обеспечиваться через Kafka как единый транспорт значимых изменений.
- Слой ML ДОЛЖЕН быть изолирован в отдельном сервисе.
- Слой LLM-агентов ДОЛЖЕН быть изолирован в независимых агентных компонентах.
- Слой хранения ДОЛЖЕН использовать Postgres (схемное разделение) и текстовые audit-логи ответов AI.
</layer_rules>

<component_interaction_rules>
- Межсервисное взаимодействие ДОЛЖНО происходить через Kafka-события или через чётко определённые API-контракты.
- Синхронные REST-вызовы НЕ ДОЛЖНЫ использоваться для тяжёлой обработки.
- При классификации транзакций ML ДОЛЖЕН применяться как первичный путь.
- Передача в LLM ДОЛЖНА выполняться только для сложных случаев.
- Consumer-узлы Kafka ДОЛЖНЫ поддерживать горизонтальное масштабирование.
</component_interaction_rules>

<data_rules>
- Ни одна транзакция НЕ ДОЛЖНА теряться.
- Модель доставки событий ДОЛЖНА быть at-least-once.
- Все компоненты, обрабатывающие события, ДОЛЖНЫ быть идемпотентными.
- После сбоя обработка ДОЛЖНА возобновляться с места останова.
- Каждая транзакция ДОЛЖНА иметь `transaction-id`.
- Для аудита ответы AI-агентов ДОЛЖНЫ сохраняться в текстовом файле.
- Для разработки и тестирования ДОЛЖНЫ использоваться синтетические транзакционные данные.
</data_rules>

<nfr_rules>
- Точность категоризации при гибридной обработке ДОЛЖНА быть не ниже 95%.
- Доля транзакций с ручной проверкой ДОЛЖНА быть меньше 0.5%.
- p95 времени категоризации ДОЛЖЕН быть меньше 2 секунд (включая случаи с LLM).
- Время ML-классификации ДОЛЖНО быть меньше 50 мс.
- Система ДОЛЖНА поддерживать пропускную способность не ниже 1000 RPS при горизонтальном масштабировании consumer-узлов.
- Использование LLM ДОЛЖНО ограничиваться примерно 10% транзакций.
- Стоимость обработки ДОЛЖНА быть не выше +15% относительно ML-only режима при расчёте на 1 млн транзакций.
- Метрики latency, error rate и LLM usage ДОЛЖНЫ быть доступны для анализа.
- Логи AI-агентов ДОЛЖНЫ сохраняться для аудита.
</nfr_rules>

<integration_rules>
- Интеграция сервисов ДОЛЖНА строиться вокруг Kafka как центральной шины.
- Интеграция с ML ДОЛЖНА выполняться через отдельный Classifier Service REST API.
- Интеграция с LLM ДОЛЖНА поддерживать внешние LLM API и локальные модели.
- API-контракты между компонентами ДОЛЖНЫ быть явными и стабильными.
- Персонализированные финансовые рекомендации ДОЛЖНЫ формироваться Financial Coach Agent на основе поведенческого анализа.
</integration_rules>

<extensibility_rules>
- Архитектура ДОЛЖНА позволять добавление новых AI-функций без изменения ядра системы.
- Архитектура ДОЛЖНА допускать добавление новых агентов без изменения доменной логики.
- ML-модель ДОЛЖНА быть заменяемой через интерфейс.
- LLM-провайдер ДОЛЖЕН быть заменяемым через интерфейс.
- Реализация Classifier Service ДОЛЖНА оставаться заменяемой (включая возможность замены на Python-реализацию в будущем).
</extensibility_rules>
